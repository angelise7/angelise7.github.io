<!DOCTYPE html><html lang="zh-cn"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Ionic在使用过程中如果使用ThemeableBrowser或者InAppBrowser进行数据交互时,两个插件都存在一定的问题。&lt;br&gt;ThemeableBrowser fork自InAppBrowser，ThemeableBrowser提供了全新的主题匹配,但是由于插件长时间未更新,在数据交互时存在一定的问题,但是我们可以根据自己的实际情况选择使用哪个插件"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Ionic3使用InAppBrowser进行数据交互 | Mccc</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 7.3.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-noise-link" href="/tags/Ionic3/" rel="tag">Ionic3</a></div><div class="post-time">2019-01-08</div></div></div><div class="container post-header"><h1>Ionic3使用InAppBrowser进行数据交互</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion"></summary><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%9C%A8%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92%E4%B8%AD-%E4%B8%BB%E8%A6%81%E9%80%9A%E8%BF%87%E4%BB%A5%E4%B8%8BAPI%E6%9D%A5%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">实际在数据交互中,主要通过以下API来实现:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-%E2%80%94%E2%80%94%E5%87%86%E5%A4%87%E4%BE%9B%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8F%92%E4%BB%B6%E8%AE%BF%E9%97%AE%E7%9A%84%E7%BD%91%E9%A1%B5"><span class="toc-number">2.</span> <span class="toc-text">准备工作 ——准备供浏览器插件访问的网页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87APP"><span class="toc-number">3.</span> <span class="toc-text">准备APP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%B9%B6%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE"><span class="toc-number">4.</span> <span class="toc-text">测试并返回数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></details></div><div class="container post-content"><p>Ionic在使用过程中如果使用ThemeableBrowser或者InAppBrowser进行数据交互时,两个插件都存在一定的问题。<br>ThemeableBrowser fork自InAppBrowser，ThemeableBrowser提供了全新的主题匹配,但是由于插件长时间未更新,在数据交互时存在一定的问题,但是我们可以根据自己的实际情况选择使用哪个插件</p>
<h4 id="实际在数据交互中-主要通过以下API来实现"><a href="#实际在数据交互中-主要通过以下API来实现" class="headerlink" title="实际在数据交互中,主要通过以下API来实现:"></a>实际在数据交互中,主要通过以下API来实现:</h4><ul>
<li>executeScript (注入JS代码到新的窗口)</li>
<li>on(loadstart、loadstop监听)</li>
<li>show  (打开窗口)</li>
<li>close (关闭窗口)</li>
</ul>
<h4 id="准备工作-——准备供浏览器插件访问的网页"><a href="#准备工作-——准备供浏览器插件访问的网页" class="headerlink" title="准备工作 ——准备供浏览器插件访问的网页"></a>准备工作 ——准备供浏览器插件访问的网页</h4><p>新建并发布一个网页，供浏览器插件访问。这里我简单用node搭建一个网页（由上往下分别是创建目录、跳过询问来配置package.json、安装express）：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir test-web &amp;&amp; cd test-web</span><br><span class="line">npm init -y</span><br><span class="line">npm i express --save</span><br></pre></td></tr></table></figure></div>

<p>新建index.js文件，并填入以下内容：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;)</span><br><span class="line">const path = require(&#x27;path&#x27;)</span><br><span class="line">const app = express()</span><br><span class="line"></span><br><span class="line">app.use(express.static(__dirname))</span><br><span class="line">app.listen(8089, () =&gt; &#123;</span><br><span class="line">  console.log(`App listening at port 8089`)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div>

<p>这样就部署了个静态网页服务器，我们再创建一个html页面和一个js文件：<br>index.html：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;</span><br><span class="line">  &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;h1&gt;获得的参数为:&lt;/h1&gt;</span><br><span class="line">  &lt;button id=&quot;send-data-btn&quot;&gt;向APP传递参数&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">  &lt;script src=&quot;test.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></div>
<p>test.js：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">var fromAppData; //获得的参数</span><br><span class="line">var sendDataBtn = document.getElementById(&#x27;send-data-btn&#x27;)</span><br><span class="line"></span><br><span class="line">var getAppData = function (data) &#123;</span><br><span class="line">  fromAppData = data;</span><br><span class="line">  alert(JSON.stringify(fromAppData));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var sendParamsToApp = function () &#123;</span><br><span class="line">  var sendData = &#x27;sendData&#x27;</span><br><span class="line">  location.href = &quot;https://www.baidu.com/?params=&quot; + sendData</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sendDataBtn.onclick = function () &#123;</span><br><span class="line">  sendParamsToApp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var getDataFromWeb = function () &#123;</span><br><span class="line">  var url = window.location.search;</span><br><span class="line">  var theRequest = new Object();</span><br><span class="line">  if (url.indexOf(&quot;?&quot;) != -1) &#123;</span><br><span class="line">    var str = url.substr(1);</span><br><span class="line">    strs = str.split(&quot;&amp;&quot;);</span><br><span class="line">    for (var i = 0; i &lt; strs.length; i++) &#123;</span><br><span class="line">      theRequest[strs[i].split(&quot;=&quot;)[0]] = decodeURI(strs[i].split(&quot;=&quot;)[1]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return theRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>执行命令启动：</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node index.js</span><br></pre></td></tr></table></figure></div>

<p>在浏览器访问一下是否能正常运行：localhost:8089，实际真机测试时换成IP访问：192.168.2.130:8089(根据自己的IP启动)</p>
<h4 id="准备APP"><a href="#准备APP" class="headerlink" title="准备APP"></a>准备APP</h4><p>安装插件后,实际代码如下home.ts</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">dataFromWeb: any;</span><br><span class="line"></span><br><span class="line">  constructor(</span><br><span class="line">    public navCtrl: NavController,</span><br><span class="line">    private iab: InAppBrowser) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  sendDataToWeb() &#123;</span><br><span class="line">    const browser = this.iab.create(&#x27;http://192.168.1.8:8089&#x27;, &#x27;_blank&#x27;);</span><br><span class="line"></span><br><span class="line">    const data = &#x27;hello!&#x27;; //发送的参数</span><br><span class="line">    const code: string = &quot;getAppData(&quot; + data + &quot;)&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    browser.on(&#x27;loadstop&#x27;).subscribe(event =&gt; &#123;</span><br><span class="line">      //发送参数</span><br><span class="line">      browser.executeScript(&#123;</span><br><span class="line">        code: code</span><br><span class="line">      &#125;)</span><br><span class="line">        .then(params =&gt; &#123;</span><br><span class="line">          console.log(params);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      //获得返回的参数</span><br><span class="line">      if (event.url.match(&quot;www.baidu.com&quot;)) &#123;</span><br><span class="line">        const code = &quot;getDataFromWeb()&quot;</span><br><span class="line"></span><br><span class="line">        browser.executeScript(&#123;</span><br><span class="line">          code: code</span><br><span class="line">        &#125;)</span><br><span class="line">          .then(params =&gt; &#123;</span><br><span class="line">            console.log(params[0])</span><br><span class="line">            this.dataFromWeb = params[0].sendData;</span><br><span class="line">            browser.close();</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>home.html:</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;ion-content padding&gt;</span><br><span class="line">  &lt;button ion-button (click)=&quot;sendDataToWeb()&quot;&gt;发送参数&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">  &lt;p *ngIf=&quot;dataFromWeb&quot;&gt;从Web收到的参数是:&#123;&#123;dataFromWeb&#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;/ion-content&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>


<h4 id="测试并返回数据"><a href="#测试并返回数据" class="headerlink" title="测试并返回数据"></a>测试并返回数据</h4><ul>
<li>简短的说明下实现原理,首先是向Web环境传递参数时,为什么选择了loadstop监听,实际web项目会存在一定的加载时间,如果选择loadstart,那么通过APP内的executeScript()方法注入执行的getAppData()方法会在一定情况下无法执行,这是由于loadstart触发的时机是打开一个新的地址就会触发,某些情况下,网页并未初始化完全即 getAppData这个方法并没有声明,就去执行,所以会报错</li>
</ul>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var fromAppData; //获得的参数</span><br><span class="line"></span><br><span class="line">var getAppData = function (data) &#123;</span><br><span class="line">  fromAppData = data;</span><br><span class="line">  alert(JSON.stringify(fromAppData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>返回参数时的原理,我们通过web点击跳转一个新的地址,然后通过?拼接的方式将参数拼接在地址栏内即:</li>
</ul>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var sendParamsToApp = function () &#123;</span><br><span class="line">  var sendData = &#x27;sendData&#x27;</span><br><span class="line">  location.href = &quot;https://www.baidu.com/?params=&quot; + sendData</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sendDataBtn.onclick = function () &#123;</span><br><span class="line">  sendParamsToApp();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>然后通过loadstop监听地址栏变化当有我们的地址出现时,从地址栏拿取参数并且关闭browser,即:</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//web</span><br><span class="line"></span><br><span class="line">var getDataFromWeb = function () &#123;</span><br><span class="line">  var url = window.location.search;</span><br><span class="line">  var theRequest = new Object();</span><br><span class="line">  if (url.indexOf(&quot;?&quot;) != -1) &#123;</span><br><span class="line">    var str = url.substr(1);</span><br><span class="line">    strs = str.split(&quot;&amp;&quot;);</span><br><span class="line">    for (var i = 0; i &lt; strs.length; i++) &#123;</span><br><span class="line">      theRequest[strs[i].split(&quot;=&quot;)[0]] = decodeURI(strs[i].split(&quot;=&quot;)[1]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return theRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//app</span><br><span class="line"></span><br><span class="line"> browser.on(&#x27;loadstop&#x27;).subscribe(event =&gt; &#123;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">      //获得返回的参数</span><br><span class="line">      if (event.url.match(&quot;www.baidu.com&quot;)) &#123;</span><br><span class="line">        const code = &quot;getDataFromWeb()&quot;</span><br><span class="line"></span><br><span class="line">        browser.executeScript(&#123;</span><br><span class="line">          code: code</span><br><span class="line">        &#125;)</span><br><span class="line">          .then(params =&gt; &#123;</span><br><span class="line">            console.log(params[0])</span><br><span class="line">            this.dataFromWeb = params[0].sendData;</span><br><span class="line">            browser.close();</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">      </span><br></pre></td></tr></table></figure></div>

<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>参考用例 <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b63d120d1e01">https://www.jianshu.com/p/b63d120d1e01</a></p>
<p>例子中的向APP返回参数的方法使用了window.open的方法然后调用方法获得参数,实际中存在两个问题;</p>
<p>1.iOS会阻止window.open的方法; 改为location.href可解决</p>
<p>2.打开一个新的域名时,新的域名下没有getDataFromWeb这个方法,在某些情况下会报错无法找到这个方法,<br>如果改为在当前域名下添加#的方法来获取URL的改变来触发loadstop,在iOS下会触发loadstop方法,但是在Android下不会触发,所以这里只能打开一个新的域名并且通过?参数拼接的方法获取参数</p>
<p>3.ThemeableBrowser插件由于长时间未更新,在iOS12下当打开web时loadstop监听会被iOS系统屏蔽掉,无法监听,所以无法用于返回参数</p>
<p>4.所以总体来说,如果只是单纯的向web传递参数,可以考虑使用ThemeableBrowser来实现,如果需要web向APP内返回参数,只能只用InAppBrowser来解决<br>5.采用上述方法,存在一个安全问题就是返回的参数是通过地址栏拼接获得,实际项目中可以通过和服务器同时约定一个加密码来用于验证数据的真伪即可解决.</p>
</div></div><div class="post-main post-comment"><div id="giscus_thread"></div><script src="https://giscus.app/client.js"
        data-repo="angelise7/blog-comments"
        data-repo-id="R_kgDOPQr6lw"
        data-category=""
        data-category-id=""
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script></div></article><link rel="stylesheet" type="text/css" href="/css/third-party/font-awesome/4.5.0/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="/js/third-party/jquery/2.0.3/jquery.min.js"></script><script src="/js/third-party/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>