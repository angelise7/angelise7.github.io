<!DOCTYPE html><html lang="zh-cn"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="依赖注入的层级等等请查看示意图&lt;br&gt;&lt;a href=&quot;https://www.processon.com/view/618b434c1e0853689b033111?fromnew=1&quot;&gt;https://www.processon.com/view/618b434c1e0853689b033111?fromnew=1&lt;/a&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Angular依赖注入 | Mccc</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 7.3.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-noise-link" href="/tags/Angular/" rel="tag">Angular</a></div><div class="post-time">2019-04-09</div></div></div><div class="container post-header"><h1>Angular依赖注入</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion"></summary><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E6%8F%90%E4%BE%9B%E5%95%86"><span class="toc-number">1.</span> <span class="toc-text">依赖提供商</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%80%BC%E6%8F%90%E4%BE%9B%E5%95%86"><span class="toc-number">2.</span> <span class="toc-text">值提供商</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%8F%90%E4%BE%9B%E5%95%86"><span class="toc-number">3.</span> <span class="toc-text">工厂提供商</span></a></li></ol></details></div><div class="container post-content"><p>依赖注入的层级等等请查看示意图<br><a target="_blank" rel="noopener" href="https://www.processon.com/view/618b434c1e0853689b033111?fromnew=1">https://www.processon.com/view/618b434c1e0853689b033111?fromnew=1</a></p>
<h4 id="依赖提供商"><a href="#依赖提供商" class="headerlink" title="依赖提供商"></a>依赖提供商</h4><p>不同的类都可用于提供相同的服务。 比如，下面的代码告诉注入器，当组件使用 Logger 令牌请求日志对象时，给它返回一个 BetterLogger 实例。</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[&#123; provide: Logger, useClass: BetterLogger &#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>


<p>当用BetterLogger替代Logger后,此时BetterLogger在应用内会被实例化两次</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	BetterLogger,</span><br><span class="line">	&#123; provide: Logger, useClass: BetterLogger &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>所以如果当你需要必须实例化一次BetterLogger的时候就用到了useExisting</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	BetterLogger,</span><br><span class="line">	&#123; provide: Logger, useExisting: BetterLogger &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<hr>
<h4 id="值提供商"><a href="#值提供商" class="headerlink" title="值提供商"></a>值提供商</h4><p>有时候你会希望注入字符串、函数或对象。通常会用来定义参数或者API请求地址等</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export const HERO_DI_CONFIG: AppConfig = &#123;</span><br><span class="line">  apiEndpoint: &#x27;api.heroes.com&#x27;,</span><br><span class="line">  title: &#x27;Dependency Injection&#x27;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">[&#123; provide: AppConfig, useValue: HERO_DI_CONFIG &#125;)]</span><br></pre></td></tr></table></figure></div>

<p>这里需要注意的是,我们的令牌除了本身可以使用的值意外也可以使用字符串或者InjectionToken对象</p>
<ul>
<li>字符串</li>
</ul>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export const HERO_DI_CONFIG: AppConfig = &#123;</span><br><span class="line">  apiEndpoint: &#x27;api.heroes.com&#x27;,</span><br><span class="line">  title: &#x27;Dependency Injection&#x27;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">[&#123; provide: &#x27;APP_CONFIG&#x27;, useValue: HERO_DI_CONFIG &#125;)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">constructor(@Inject(&#x27;APP_CONFIG&#x27;) GLOBAL_ENV)&#123;&#125;</span><br></pre></td></tr></table></figure></div>


<ul>
<li>InjectionToken对象</li>
</ul>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import &#123; InjectionToken &#125; from &#x27;@angular/core&#x27;;</span><br><span class="line"></span><br><span class="line">export const APP_CONFIG = new InjectionToken&lt;AppConfig&gt;(&#x27;app.config&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//config.ts</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export const HERO_DI_CONFIG: AppConfig = &#123;</span><br><span class="line">  apiEndpoint: &#x27;api.heroes.com&#x27;,</span><br><span class="line">  title: &#x27;Dependency Injection&#x27;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">[&#123; provide: APP_CONFIG, useValue: HERO_DI_CONFIG &#125;)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">constructor(@Inject(APP_CONFIG) GLOBAL_ENV)&#123;&#125;</span><br></pre></td></tr></table></figure></div>

<p>相比于官方提供的方法这里更简洁的方法可以使用字符串,这样不需要在使用是频繁的引入config.ts文件</p>
<hr>
<h4 id="工厂提供商"><a href="#工厂提供商" class="headerlink" title="工厂提供商"></a>工厂提供商</h4><p>当需要动态创建依赖值时,比如需要从第三方库创建依赖时,你不能直接访问第三方库的实例,这时候就需要工厂提供商,比如当我们登录后可以拿到某个列表,不登录时会返回一个空列表</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">export class HeroService &#123;</span><br><span class="line"></span><br><span class="line">  HEROES = [1, 2, 3, 4]</span><br><span class="line"></span><br><span class="line">  constructor(</span><br><span class="line">    private isAuthorized: boolean</span><br><span class="line">  ) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getHeroes() &#123;</span><br><span class="line">    let HEROES = [];</span><br><span class="line"></span><br><span class="line">    if (this.isAuthorized) &#123;</span><br><span class="line">      HEROES = this.HEROES</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      HEROES = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return HEROES;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>这时你需要一个isAuthorized标志来控制,虽然HeroService不能直接访问UserService,但是工厂函数可以</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let heroServiceFactory = (userService: UserService) =&gt; &#123;</span><br><span class="line">  return new HeroService(userService.user.isAuthorized);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export let heroServiceProvider =</span><br><span class="line">&#123;</span><br><span class="line">  provide: HeroService,</span><br><span class="line">  useFactory: heroServiceFactory,</span><br><span class="line">  deps: [UserService]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>
<p>组件中使用时</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroServiceProvider.useFactory(this.UserService).getHeroes()</span><br></pre></td></tr></table></figure></div></div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'MCCC-1';
var disqus_identifier = '2019/04/09/Angular依赖注入-DI提供商/';
var disqus_title = 'Angular依赖注入';
var disqus_url = 'http://example.com/2019/04/09/Angular%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5-DI%E6%8F%90%E4%BE%9B%E5%95%86/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a target="_blank" rel="noopener" href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a><div id="giscus_thread"></div><script src="https://giscus.app/client.js"
        data-repo="angelise7/blog-comments"
        data-repo-id="R_kgDOPQr6lw"
        data-category=""
        data-category-id=""
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script></div></article><link rel="stylesheet" type="text/css" href="/css/third-party/font-awesome/4.5.0/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="/js/third-party/jquery/2.0.3/jquery.min.js"></script><script src="/js/third-party/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>