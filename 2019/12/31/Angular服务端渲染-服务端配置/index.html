<!DOCTYPE html><html lang="zh-cn"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="本地项目的准备工作请参考官方文档,不做解释,&lt;a href=&quot;https://angular.cn/guide/universal&quot;&gt;https://angular.cn/guide/universal&lt;/a&gt; 可以参考示例代码,&lt;br&gt;需要注意的时,配置文件的时候请检查好文件路径"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Angular-SSR(服务端配置)过程记录 | Mccc</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 7.3.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-noise-link" href="/tags/Angular/" rel="tag">Angular</a></div><div class="post-time">2019-12-31</div></div></div><div class="container post-header"><h1>Angular-SSR(服务端配置)过程记录</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion"></summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9C%AC%E5%9C%B0%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">1.本地准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%B8%BB%E8%A6%81%E7%9A%84%E6%94%B9%E5%8A%A8"><span class="toc-number">1.1.</span> <span class="toc-text">1.主要的改动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.</span> <span class="toc-text">2.打包脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Docker%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">3.Docker配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">2.</span> <span class="toc-text">2.服务器部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%85%8B%E9%9A%86%E9%A1%B9%E7%9B%AE%E5%B9%B6%E4%B8%94%E6%89%A7%E8%A1%8C%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC"><span class="toc-number">2.1.</span> <span class="toc-text">1.克隆项目并且执行部署脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AENginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">2.配置Nginx反向代理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%80%9A%E8%BF%87volume%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%8A%A0%E9%80%9F%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">2.3.</span> <span class="toc-text">3.通过volume进一步加速静态资源</span></a></li></ol></li></ol></details></div><div class="container post-content"><p>本地项目的准备工作请参考官方文档,不做解释,<a target="_blank" rel="noopener" href="https://angular.cn/guide/universal">https://angular.cn/guide/universal</a> 可以参考示例代码,<br>需要注意的时,配置文件的时候请检查好文件路径</p>
<p>这里主要介绍在使用Docker部署过程中的的问题记录,由于对express和Docker只是了解些皮毛,只是初步实现了目的.</p>
<p>这里项目名称统一为my-app</p>
<h3 id="1-本地准备工作"><a href="#1-本地准备工作" class="headerlink" title="1.本地准备工作"></a>1.本地准备工作</h3><h4 id="1-主要的改动"><a href="#1-主要的改动" class="headerlink" title="1.主要的改动"></a>1.主要的改动</h4><ol>
<li>新增的文件</li>
</ol>
<ul>
<li><code>app.server.module.ts</code></li>
<li><code>main.server.ts</code></li>
<li><code>webpack.server.config.js</code></li>
<li><code>server.ts</code></li>
<li><code>tsconfig.server.json</code></li>
</ul>
 <div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//如果用了hmr,compilerOptions里的types请保持和tsconfig.app.json一致</span><br><span class="line">  &#123;</span><br><span class="line">     ...</span><br><span class="line">    &quot;compilerOptions&quot;: &#123;</span><br><span class="line">     ...</span><br><span class="line">     &quot;types&quot;: [&quot;node&quot;]</span><br><span class="line">     ...</span><br><span class="line">    &#125;,</span><br><span class="line">  ...</span><br><span class="line">  &#125;  </span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>改动的文件</li>
</ol>
<ul>
<li><code>app.module.ts</code></li>
<li><code>angular.json</code></li>
</ul>
 <br>
 
<h4 id="2-打包脚本"><a href="#2-打包脚本" class="headerlink" title="2.打包脚本"></a>2.打包脚本</h4><p>由于开发时ngcli安装在本地全局,但服务器环境时,全局不存在ng,所以需要使用npx来调用项目内部的库来实现打包</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//package.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  &quot;scripts&quot;:&#123;</span><br><span class="line">    ...</span><br><span class="line">    &quot;webpack:server&quot;:&quot;webpack --config webpack.server.config.js --progress --colors&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//build-dev.sh</span><br><span class="line"></span><br><span class="line">npx ng  build --prod --configuration=development --output-hashing=all&amp;&amp;</span><br><span class="line">npx ng run my-app:server&amp;&amp;</span><br><span class="line">npm run webpack:server</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>部署前,请在本地运行脚本并且启动确保没有错误</p>
<Br>

<h4 id="3-Docker配置"><a href="#3-Docker配置" class="headerlink" title="3.Docker配置"></a>3.Docker配置</h4><ol>
<li>Dockerfile文件配置</li>
</ol>
<p>EXPOS端口时,请保持和 <code>server.ts</code> 的端口一致</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//Dockerfile-dev</span><br><span class="line"></span><br><span class="line">FROM node:10</span><br><span class="line"></span><br><span class="line">RUN sed -i -e &quot;s/deb.debian.org/mirrors.163.com/g&quot; /etc/apt/sources.list</span><br><span class="line">RUN apt-get update</span><br><span class="line">RUN apt-get install -y rsync</span><br><span class="line"></span><br><span class="line">RUN npm config set registry https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line">WORKDIR /usr/src/app</span><br><span class="line">COPY  .  /usr/src/app</span><br><span class="line">RUN npm install </span><br><span class="line">RUN ./build-dev.sh</span><br><span class="line">EXPOSE 4000</span><br><span class="line">ENTRYPOINT node dist/server.js</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>初始化部署文件</li>
</ol>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//docker-init-dev.sh</span><br><span class="line"></span><br><span class="line">//创建镜像和容器</span><br><span class="line">docker build -t my-app:dev -f Dockerfile-dev .</span><br><span class="line"></span><br><span class="line">//创建网络</span><br><span class="line">docker network create --driver overlay --subnet 192.168.200.0/24  my-app-network </span><br><span class="line"></span><br><span class="line">//创建服务以便于访问内部</span><br><span class="line">docker service create --mount src=my-app,dst=/usr/src/app/dist/my-app   --name my-app-server    --network  my-app-server-network  -p  21000:4000 tailor-web-server:dev</span><br></pre></td></tr></table></figure></div>

<ol start="3">
<li>更新部署文件</li>
</ol>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//docker-deploy-dev.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker build -t himark-admin-server:dev -f Dockerfile-dev .</span><br><span class="line"></span><br><span class="line">&amp;&amp; docker service update  --container-label-add last_deployed=$(date -u +%Y-%m-%dT%H:%M:%S)  himark-admin-server</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<hr>
<h3 id="2-服务器部署"><a href="#2-服务器部署" class="headerlink" title="2.服务器部署"></a>2.服务器部署</h3><h4 id="1-克隆项目并且执行部署脚本"><a href="#1-克隆项目并且执行部署脚本" class="headerlink" title="1.克隆项目并且执行部署脚本"></a>1.克隆项目并且执行部署脚本</h4><div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./docker-init-dev.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>部署后请查看镜像,容器,网络和服务是否都启动成功,执行对应命令即可</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker image ls </span><br><span class="line"></span><br><span class="line">docker container ls </span><br><span class="line"></span><br><span class="line">docker network ls</span><br><span class="line"></span><br><span class="line">docker service ls</span><br></pre></td></tr></table></figure></div>
<br>

<h4 id="2-配置Nginx反向代理"><a href="#2-配置Nginx反向代理" class="headerlink" title="2.配置Nginx反向代理"></a>2.配置Nginx反向代理</h4><div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  server_name   xxxxxxx;</span><br><span class="line">  </span><br><span class="line">  location / &#123;</span><br><span class="line">      proxy_pass http://127.0.0.1:21000;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="3-通过volume进一步加速静态资源"><a href="#3-通过volume进一步加速静态资源" class="headerlink" title="3.通过volume进一步加速静态资源"></a>3.通过volume进一步加速静态资源</h4><p><img src="/images/ssr/1.jpg" alt="upload successful"></p>
<p>创建数据卷</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker volume create my-app</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>查看数据卷</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker volume inspect my-app</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;xxxx&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/data/docker/volumes/my-app/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;my-app&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></div>
<p>配置Nginx,通过过滤筛选条件将带后缀名的文件从数据卷中读取</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server_name   xxxxxxx;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">location ~* ^/(.*\.[^/]*)$ &#123;</span><br><span class="line">   alias /data/docker/volumes/my-app/_data/$1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">       proxy_pass http://127.0.0.1:21000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div></div><div class="post-main post-comment"><div id="giscus_thread"></div><script src="https://giscus.app/client.js"
        data-repo="angelise7/blog-comments"
        data-repo-id="R_kgDOPQr6lw"
        data-category=""
        data-category-id=""
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script></div></article><link rel="stylesheet" type="text/css" href="/css/third-party/font-awesome/4.5.0/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="/js/third-party/jquery/2.0.3/jquery.min.js"></script><script src="/js/third-party/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>