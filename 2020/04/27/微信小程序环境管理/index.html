<!DOCTYPE html><html lang="zh-cn"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="由于小程序的限制,无法设置开发和正式的环境变量,这里参考node的方法来设置小程序的环境变量,由于小程序的限制,不管是体验版或开发版还是正式版,都是使用的一份本地缓存,当手机同时存在两个或两个以上小程序版本时,就会因为缓存的原因读取错误的本地缓存,除非有后端人员介入对错误进行处理,否则只能删除小程序以保证能正常使用,当然还有一个好处是保证了我们线上的正式版一定是生产环境"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>微信小程序环境管理 | Mccc</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 7.3.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-noise-link" href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">微信小程序</a></div><div class="post-time">2020-04-27</div></div></div><div class="container post-header"><h1>微信小程序环境管理</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion"></summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%A6%96%E5%85%88%E5%88%9B%E5%BB%BA%E7%8E%AF%E5%A2%83%E6%96%87%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">1. 首先创建环境文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B0%81%E8%A3%85%E4%B8%A4%E4%B8%AA%E5%B8%B8%E9%87%8F-Symbol-%E6%98%AF%E4%B8%BA%E4%BA%86%E6%B6%88%E9%99%A4%E9%AD%94%E6%9C%AF%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%98%B2%E6%AD%A2%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E9%94%99%E8%AF%AF"><span class="toc-number">2.</span> <span class="toc-text">2.封装两个常量,, Symbol() 是为了消除魔术字符串防止不必要的错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%80%9A%E8%BF%87wx-getAccountInfoSync-%E6%96%B9%E6%B3%95%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%8B%BF%E5%88%B0%E5%BD%93%E5%89%8D%E8%BF%90%E8%A1%8C%E7%9A%84%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%89%88%E6%9C%AC-%E7%84%B6%E5%90%8E%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%A0%B9%E6%8D%AE%E5%85%B7%E4%BD%93%E7%9A%84%E6%83%85%E5%86%B5%E8%AE%BE%E7%BD%AE%E5%BD%93%E5%89%8D%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">3.</span> <span class="toc-text">3.通过wx.getAccountInfoSync()方法我们可以拿到当前运行的小程序版本,然后是可以根据具体的情况设置当前环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-environment%E5%B0%B1%E6%98%AF%E6%88%91%E4%BB%AC%E5%BD%93%E5%89%8D%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%82%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">4.environment就是我们当前的环境参数</span></a></li></ol></details></div><div class="container post-content"><p>由于小程序的限制,无法设置开发和正式的环境变量,这里参考node的方法来设置小程序的环境变量,由于小程序的限制,不管是体验版或开发版还是正式版,都是使用的一份本地缓存,当手机同时存在两个或两个以上小程序版本时,就会因为缓存的原因读取错误的本地缓存,除非有后端人员介入对错误进行处理,否则只能删除小程序以保证能正常使用,当然还有一个好处是保证了我们线上的正式版一定是生产环境</p>
<h3 id="1-首先创建环境文件"><a href="#1-首先创建环境文件" class="headerlink" title="1. 首先创建环境文件"></a>1. 首先创建环境文件</h3><div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">--- enviroments</span><br><span class="line">  --- enviroment.js</span><br><span class="line">  --- enviroment.prod.js</span><br><span class="line">...  </span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>以下只是个参考例子,具体情况根据自己的需要设置</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export const environment = &#123;</span><br><span class="line">    production: false,</span><br><span class="line"></span><br><span class="line">    GlobalConfigApiServer: &#x27;测试&#x27;,</span><br><span class="line">    TOKEN: &#x27;Dev_Token&#x27;,</span><br><span class="line">    USER: &#x27;Dev_UserInfor&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h3 id="2-封装两个常量-Symbol-是为了消除魔术字符串防止不必要的错误"><a href="#2-封装两个常量-Symbol-是为了消除魔术字符串防止不必要的错误" class="headerlink" title="2.封装两个常量,, Symbol() 是为了消除魔术字符串防止不必要的错误"></a>2.封装两个常量,, <code>Symbol()</code> 是为了消除魔术字符串防止不必要的错误</h3><div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">export const ENV_VERSION=&#123;</span><br><span class="line">    develop: &#x27;develop&#x27;,//开发版本</span><br><span class="line">    trial: &#x27;trial&#x27;,//体验版</span><br><span class="line">    release: &#x27;release&#x27;,//正式版</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">export const ENVIRONMENT = &#123;</span><br><span class="line">    prod: Symbol(&#x27;prod&#x27;),</span><br><span class="line">    dev: Symbol(&#x27;dev&#x27;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>


<h3 id="3-通过wx-getAccountInfoSync-方法我们可以拿到当前运行的小程序版本-然后是可以根据具体的情况设置当前环境变量"><a href="#3-通过wx-getAccountInfoSync-方法我们可以拿到当前运行的小程序版本-然后是可以根据具体的情况设置当前环境变量" class="headerlink" title="3.通过wx.getAccountInfoSync()方法我们可以拿到当前运行的小程序版本,然后是可以根据具体的情况设置当前环境变量"></a>3.通过<code>wx.getAccountInfoSync()</code>方法我们可以拿到当前运行的小程序版本,然后是可以根据具体的情况设置当前环境变量</h3><div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">globalData: &#123;</span><br><span class="line">    GlobalConfigApiServer: ENVIRONMENT.prod,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>这里只设置了开发版和体验版就是为了保证线上的版本永远是生产环境,当然我们可以进一步强化这种保险就是在书写<code>ENV_VERSION</code>常量的时候只写入体验版和开发板,就能进一步防止错误操作</p>
<div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">checkEnviroment() &#123;</span><br><span class="line">     //开发版</span><br><span class="line">     if (envVersion === ENV_VERSION.develop) &#123;</span><br><span class="line">         this.globalData.GlobalConfigApiServer = ENVIRONMENT.dev;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     //体验版</span><br><span class="line">     else if (envVersion === ENV_VERSION.trial) &#123;</span><br><span class="line">        this.globalData.GlobalConfigApiServer = ENVIRONMENT.dev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<h3 id="4-environment就是我们当前的环境参数"><a href="#4-environment就是我们当前的环境参数" class="headerlink" title="4.environment就是我们当前的环境参数"></a>4.<code>environment</code>就是我们当前的环境参数</h3><div class="noise-code-block" style="--code-block-max-height:inherit;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const app = getApp();</span><br><span class="line"></span><br><span class="line">const environmentPath = app.globalData.GlobalConfigApiServer === ENVIRONMENT.prod ? &#x27;environment.prod&#x27; : &#x27;environment&#x27;;</span><br><span class="line">const &#123; environment &#125; = require(&#x27;../../environments/&#x27; + environmentPath);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div></div><div class="post-main post-comment"><div id="giscus_thread"></div><script src="https://giscus.app/client.js"
        data-repo="angelise7/blog-comments"
        data-repo-id="R_kgDOPQr6lw"
        data-category=""
        data-category-id=""
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script></div></article><link rel="stylesheet" type="text/css" href="/css/third-party/font-awesome/4.5.0/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="/js/third-party/jquery/2.0.3/jquery.min.js"></script><script src="/js/third-party/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>